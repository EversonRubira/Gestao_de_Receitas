<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/backoffice.css">
</head>
<body class="backoffice">
    <%- include('../../partials/backoffice-header') %>

    <div class="backoffice-container">
        <%- include('../../partials/backoffice-sidebar') %>

        <main class="backoffice-content">
            <h1><%= title %></h1>

            <% if (error) { %>
                <div class="alert alert-error">
                    <%= error %>
                </div>
            <% } %>

            <div class="form-container">
                <% if (receita) { %>
                    <form method="POST" action="/backoffice/receitas/editar/<%= receita.id %>" enctype="multipart/form-data">
                <% } else { %>
                    <form method="POST" action="/backoffice/receitas/nova" enctype="multipart/form-data">
                <% } %>
                    <div class="form-group">
                        <label for="nome">Nome da Receita: *</label>
                        <% if (receita) { %>
                            <input type="text" id="nome" name="nome" value="<%= receita.nome %>" required>
                        <% } else { %>
                            <input type="text" id="nome" name="nome" value="" required>
                        <% } %>
                    </div>

                    <div class="form-group">
                        <label for="autor">Autor: *</label>
                        <% if (receita) { %>
                            <input type="text" id="autor" name="autor" value="<%= receita.autor %>" required>
                        <% } else { %>
                            <input type="text" id="autor" name="autor" value="" required>
                        <% } %>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoria_id">Categoria: *</label>
                            <select id="categoria_id" name="categoria_id" required>
                                <option value="">Selecione uma categoria</option>
                                <% for (let i = 0; i < categorias.length; i++) { %>
                                    <option value="<%= categorias[i].id %>"
                                        <% if (receita && receita.categoria_id == categorias[i].id) { %>selected<% } %>>
                                        <%= categorias[i].nome %>
                                    </option>
                                <% } %>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="dificuldade_id">Dificuldade: *</label>
                            <select id="dificuldade_id" name="dificuldade_id" required>
                                <option value="">Selecione a dificuldade</option>
                                <% for (let i = 0; i < dificuldades.length; i++) { %>
                                    <option value="<%= dificuldades[i].id %>"
                                        <% if (receita && receita.dificuldade_id == dificuldades[i].id) { %>selected<% } %>>
                                        <%= dificuldades[i].nivel %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tempo_preparacao">Tempo de Preparação (minutos): *</label>
                            <% if (receita) { %>
                                <input type="number" id="tempo_preparacao" name="tempo_preparacao" min="1" value="<%= receita.tempo_preparacao %>" required>
                            <% } else { %>
                                <input type="number" id="tempo_preparacao" name="tempo_preparacao" min="1" value="" required>
                            <% } %>
                        </div>

                        <div class="form-group">
                            <label for="custo">Custo (€): *</label>
                            <% if (receita) { %>
                                <input type="number" id="custo" name="custo" step="0.01" min="0" value="<%= receita.custo %>" required>
                            <% } else { %>
                                <input type="number" id="custo" name="custo" step="0.01" min="0" value="" required>
                            <% } %>
                        </div>

                        <div class="form-group">
                            <label for="porcoes">Porções: *</label>
                            <% if (receita) { %>
                                <input type="number" id="porcoes" name="porcoes" min="1" value="<%= receita.porcoes %>" required>
                            <% } else { %>
                                <input type="number" id="porcoes" name="porcoes" min="1" value="1" required>
                            <% } %>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="imagem">Imagem da Receita:</label>
                        <% if (receita && receita.imagem) { %>
                            <div style="margin-bottom: 10px;">
                                <img id="imagem-preview" src="<%= receita.imagem %>" alt="Preview" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                            </div>
                        <% } else { %>
                            <div id="imagem-preview-container" style="display: none; margin-bottom: 10px;">
                                <img id="imagem-preview" src="" alt="Preview" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                            </div>
                        <% } %>
                        <input type="file" id="imagem" name="imagem" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp">
                        <small style="display: block; margin-top: 5px; color: #666;">
                            Formatos aceites: JPG, PNG, GIF, WEBP (max 5MB)
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="descricao_preparacao">Descrição da Preparação: *</label>
                        <% if (receita) { %>
                            <textarea id="descricao_preparacao" name="descricao_preparacao" required style="min-height: 200px;"><%= receita.descricao_preparacao %></textarea>
                        <% } else { %>
                            <textarea id="descricao_preparacao" name="descricao_preparacao" required style="min-height: 200px;"></textarea>
                        <% } %>
                    </div>

                    <div class="form-group">
                        <label>Ingredientes:</label>
                        <div id="ingredientes-container" style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background: #f9f9f9;">
                            <div id="ingredientes-lista" style="margin-bottom: 10px;">
                                <!-- Ingredientes adicionados aparecerão aqui -->
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <select id="ingrediente-select" style="flex: 2;">
                                    <option value="">Selecione um ingrediente</option>
                                    <% for (let i = 0; i < ingredientes.length; i++) { %>
                                        <option value="<%= ingredientes[i].id %>"><%= ingredientes[i].nome %></option>
                                    <% } %>
                                </select>
                                <input type="text" id="quantidade-input" placeholder="Quantidade (ex: 200g, 2 unidades)" style="flex: 2;">
                                <button type="button" id="adicionar-ingrediente" class="btn btn-secondary" style="flex: 1;">Adicionar</button>
                            </div>
                        </div>
                        <input type="hidden" id="ingredientes" name="ingredientes" value="">
                    </div>

                    <div class="form-actions">
                        <% if (receita) { %>
                            <button type="submit" class="btn btn-primary">Atualizar Receita</button>
                        <% } else { %>
                            <button type="submit" class="btn btn-primary">Criar Receita</button>
                        <% } %>
                        <a href="/backoffice/receitas" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>

                <script>
                    // Gestao de ingredientes
                    var ingredientesSelecionados = [];

                    <% if (receita && receita.ingredientes) { %>
                        // Carregar ingredientes da receita
                        <% for (let i = 0; i < receita.ingredientes.length; i++) { %>
                            ingredientesSelecionados.push({
                                id: <%= receita.ingredientes[i].ingrediente_id %>,
                                nome: '<%= receita.ingredientes[i].nome %>',
                                quantidade: '<%= receita.ingredientes[i].quantidade %>'
                            });
                        <% } %>
                        renderizarIngredientes();
                    <% } %>

                    document.getElementById('adicionar-ingrediente').addEventListener('click', function() {
                        var select = document.getElementById('ingrediente-select');
                        var quantidade = document.getElementById('quantidade-input').value;

                        if (select.value == '' || quantidade == '') {
                            alert('Por favor, selecione um ingrediente e informe a quantidade.');
                            return;
                        }

                        var ingredienteId = select.value;
                        var ingredienteNome = select.options[select.selectedIndex].text;

                        // Verificar se ja existe
                        var jaExiste = false;
                        for (var i = 0; i < ingredientesSelecionados.length; i++) {
                            if (ingredientesSelecionados[i].id == ingredienteId) {
                                jaExiste = true;
                                break;
                            }
                        }

                        if (jaExiste) {
                            alert('Este ingrediente já foi adicionado.');
                            return;
                        }

                        ingredientesSelecionados.push({
                            id: ingredienteId,
                            nome: ingredienteNome,
                            quantidade: quantidade
                        });

                        // Limpar campos
                        select.value = '';
                        document.getElementById('quantidade-input').value = '';

                        renderizarIngredientes();
                    });

                    function renderizarIngredientes() {
                        var lista = document.getElementById('ingredientes-lista');
                        lista.innerHTML = '';

                        if (ingredientesSelecionados.length == 0) {
                            lista.innerHTML = '<p style="color: #666; margin: 0;">Nenhum ingrediente adicionado.</p>';
                        } else {
                            for (var i = 0; i < ingredientesSelecionados.length; i++) {
                                var ing = ingredientesSelecionados[i];
                                var div = document.createElement('div');
                                div.style.display = 'flex';
                                div.style.justifyContent = 'space-between';
                                div.style.alignItems = 'center';
                                div.style.padding = '8px';
                                div.style.background = 'white';
                                div.style.marginBottom = '5px';
                                div.style.borderRadius = '4px';

                                var span = document.createElement('span');
                                span.innerHTML = '<strong>' + ing.nome + '</strong> - ' + ing.quantidade;

                                var btn = document.createElement('button');
                                btn.type = 'button';
                                btn.className = 'btn btn-small btn-danger';
                                btn.style.padding = '4px 8px';
                                btn.textContent = 'Remover';
                                btn.setAttribute('data-index', i);
                                btn.onclick = function() {
                                    removerIngrediente(this.getAttribute('data-index'));
                                };

                                div.appendChild(span);
                                div.appendChild(btn);
                                lista.appendChild(div);
                            }
                        }

                        // Atualizar campo hidden
                        document.getElementById('ingredientes').value = JSON.stringify(ingredientesSelecionados);
                    }

                    function removerIngrediente(index) {
                        var novosIngredientes = [];
                        for (var i = 0; i < ingredientesSelecionados.length; i++) {
                            if (i != index) {
                                novosIngredientes.push(ingredientesSelecionados[i]);
                            }
                        }
                        ingredientesSelecionados = novosIngredientes;
                        renderizarIngredientes();
                    }

                    // Inicializar visualização
                    renderizarIngredientes();
                </script>
            </div>
        </main>
    </div>
</body>
</html>
